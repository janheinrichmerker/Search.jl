name: "Release"

on:
  push:
    tags:
      - v*

jobs:
  test:
    name: "ğŸ§ª Test"
    runs-on: ubuntu-20.04
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Julia"
        uses: julia-actions/setup-julia@v1
        with:
          version: "1.5"
      - name: "ğŸ’¾ Cache artifacts"
        uses: actions/cache@v1
        env:
          cache-name: cache-artifacts
        with:
          path: ~/.julia/artifacts
          key: ${{ runner.os }}-test-${{ env.cache-name }}-${{ hashFiles('**/Project.toml') }}
          restore-keys: |
            ${{ runner.os }}-test-${{ env.cache-name }}-
            ${{ runner.os }}-test-
            ${{ runner.os }}-
      - name: "ğŸ—ï¸ Build package"
        uses: julia-actions/julia-buildpkg@v1
      - name: "ğŸ§ª Run tests"
        uses: julia-actions/julia-runtest@v1
      - name: "ğŸ“Š Process test coverage"
        uses: julia-actions/julia-processcoverage@v1
      - name: "ğŸ“¤ Upload test coverage"
        uses: actions/upload-artifact@v2
        with:
          path: lcov.info
          name: Test coverage
      - name: "ğŸ“¤ Publish test coverage"
        uses: codecov/codecov-action@v1
        with:
          file: lcov.info
  docs:
    name: "ğŸ“š Documentation"
    runs-on: ubuntu-20.04
    needs:
      - test
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ§° Install Julia"
        uses: julia-actions/setup-julia@v1
        with:
          version: "1.5"
      - name: "ğŸ’¾ Cache Julia artifacts"
        uses: actions/cache@v1
        env:
          cache-name: cache-artifacts
        with:
          path: ~/.julia/artifacts
          key: ${{ runner.os }}-docs-${{ env.cache-name }}-${{ hashFiles('**/Project.toml') }}
          restore-keys: |
            ${{ runner.os }}-docs-${{ env.cache-name }}-
            ${{ runner.os }}-docs-
            ${{ runner.os }}-
      - name: "ğŸ—ï¸ Build Julia package"
        uses: julia-actions/julia-buildpkg@v1
      - name: "ğŸ“š Deploy documentation to GitHub Pages"
        uses: julia-actions/julia-docdeploy@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCUMENTER_KEY: ${{ secrets.DOCUMENTER_KEY }}
  release:
    name: "ğŸš€ Release"
    runs-on: ubuntu-20.04
    needs:
      - test
    steps:
      - name: "ğŸ“¥ Check-out"
        uses: actions/checkout@v2
      - name: "ğŸ·ï¸ Get version tag"
        id: get-version
        run: echo ::set-output name=tag::${GITHUB_REF/refs\/tags\//}
      - name: "âœï¸ Generate changelog"
        id: generate-changelog
        if: runner.os == 'Linux'
        uses: heinrichreimer/action-github-changelog-generator@v2
        with:
          onlyLastTag: "true"
          stripHeaders: "true"
          stripGeneratorNotice: "true"
      - name: "ğŸ“¤ Upload changelog"
        uses: actions/upload-artifact@v2
        with:
          path: ./CHANGELOG.md
          name: Changelog
      - name: "ğŸš€ Create GitHub release"
        id: create-github-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get-version.outputs.tag }}
          body: ${{ steps.generate-changelog.outputs.changelog }}
          prerelease: false
